# Grafana Webhook Debugger

é€™æ˜¯ä¸€å€‹è¼•é‡ç´šçš„ Webhook ç›£è½ä¼ºæœå™¨ï¼Œå°ˆé–€ç”¨æ–¼é™¤éŒ¯ Grafana Alerting é€šçŸ¥å•é¡Œã€‚

## ğŸ¯ å°ˆæ¡ˆç›®çš„

æœ¬å°ˆæ¡ˆçš„å»ºç«‹æ˜¯å› ç‚ºåœ¨ä½¿ç”¨ Grafana è¨­å®š Contact Points (Telegram) æ™‚é‡åˆ°è¨Šæ¯ç„¡æ³•é€é”ä¸”ç„¡éŒ¯èª¤è¨Šæ¯çš„ç‹€æ³ã€‚ç‚ºäº†æ’æŸ¥å•é¡Œï¼Œæˆ‘å€‘å»ºç«‹é€™å€‹ Webhook Server ä¾†ç›´æ¥æ””æˆªä¸¦é¡¯ç¤º Grafana ç™¼å‡ºçš„ Alert Payloadã€‚

é€éé€™å€‹å·¥å…·ï¼Œä½ å¯ä»¥ï¼š

1. ç¢ºèª Grafana æ˜¯å¦çœŸçš„æœ‰ç™¼å‡º Alertã€‚
2. æª¢è¦– Grafana ç™¼å‡ºçš„å®Œæ•´ JSON è³‡æ–™çµæ§‹ã€‚
3. é©—è­‰ label èˆ‡ annotation çš„å…§å®¹æ˜¯å¦ç¬¦åˆé æœŸã€‚

## ğŸš€ åŠŸèƒ½ç‰¹è‰²

- **å½©è‰²æ—¥èªŒ**ï¼šä½¿ç”¨ ANSI é¡è‰²ç¢¼å€åˆ† HTTP æ–¹æ³•ã€URLã€æ™‚é–“æˆ³è¨˜èˆ‡å…§å®¹ï¼Œæå‡é–±è®€æ€§ã€‚
- **çµæ§‹åŒ–è¼¸å‡º**ï¼šè‡ªå‹•å°‡æ¥æ”¶åˆ°çš„ JSON Body æ ¼å¼åŒ–ä¸¦å±•é–‹ï¼Œæ–¹ä¾¿é–±è®€å·¢ç‹€çµæ§‹ã€‚
- **éŒ¯èª¤è™•ç†**ï¼šåŒ…å«åŸºç¤çš„éŒ¯èª¤æ•æ‰ï¼Œé¿å…å› ç‚ºæ ¼å¼éŒ¯èª¤å°è‡´ä¼ºæœå™¨å´©æ½°ã€‚
- **å½ˆæ€§é…ç½®**ï¼šæ”¯æ´é€éç’°å¢ƒè®Šæ•¸èª¿æ•´å„ç¨®è¨­å®šã€‚
- **Request ID è¿½è¹¤**ï¼šæ¯å€‹è«‹æ±‚é…æœ‰å”¯ä¸€ IDï¼Œæ–¹ä¾¿é™¤éŒ¯é—œè¯ã€‚
- **API Token é©—è­‰**ï¼šæ”¯æ´ Header é©—è­‰ï¼Œé˜²æ­¢æœªæˆæ¬Šè¨ªå•ã€‚
- **Rate Limiting**ï¼šæ¯åˆ†é˜è«‹æ±‚æ¬¡æ•¸é™åˆ¶ï¼Œé˜²æ­¢æ¿«ç”¨ã€‚
- **IP ç™½åå–®**ï¼šå¯é™åˆ¶è¨ªå•ä¾†æº IPã€‚
- **Payload é©—è­‰**ï¼šé©—è­‰ Grafana webhook å¿…è¦æ¬„ä½ã€‚
- **CORS æ”¯æ´**ï¼šå…è¨±è·¨åŸŸè«‹æ±‚ã€‚
- **è«‹æ±‚é«”å¤§å°é™åˆ¶**ï¼šé˜²æ­¢å¤§æª”æ¡ˆæ”»æ“Šã€‚
- **è«‹æ±‚çµ±è¨ˆ**ï¼šæä¾› `/stats` ç«¯é»æŸ¥çœ‹æµé‡çµ±è¨ˆã€‚
- **Graceful Shutdown**ï¼šå„ªé›…é—œé–‰ä¼ºæœå™¨ã€‚
- **å–®å…ƒæ¸¬è©¦**ï¼šå®Œæ•´çš„ Jest æ¸¬è©¦è¦†è“‹ã€‚

## ğŸ› ï¸ å®‰è£èˆ‡åŸ·è¡Œ

### å‰ç½®éœ€æ±‚

- Node.js (å»ºè­° v18+)

### 1. å®‰è£ä¾è³´

```bash
npm install express
```

### 2. å•Ÿå‹•ä¼ºæœå™¨

```bash
# é è¨­ç›£è½ 9999 port
node server.js

# æˆ–è€…æŒ‡å®šå…¶ä»– port
PORT=3000 node server.js
```

### 3. VS Code é™¤éŒ¯

æœ¬å°ˆæ¡ˆå·²åŒ…å« `.vscode/launch.json`ï¼Œæ‚¨å¯ä»¥ç›´æ¥åœ¨ VS Code ä¸­æŒ‰ä¸‹ `F5` å•Ÿå‹•é™¤éŒ¯æ¨¡å¼ã€‚

## âš™ï¸ ç’°å¢ƒè®Šæ•¸è¨­å®š (.env)

æœ¬å°ˆæ¡ˆæ”¯æ´é€é `.env` æª”æ¡ˆé€²è¡Œè©³ç´°è¨­å®šã€‚è«‹è¤‡è£½ `.env.example`ï¼ˆè‹¥ç„¡å‰‡ç›´æ¥å»ºç«‹ `.env`ï¼‰ä¸¦ä¾éœ€æ±‚ä¿®æ”¹ï¼š

```env
# ä¼ºæœå™¨ç›£è½åŸ å£ (é è¨­: 9999)
PORT=9999

# API Token é©—è­‰ (å¯é¸)
# åœ¨è«‹æ±‚æ™‚é ˆåŠ ä¸Š Header: X-API-TOKEN
API_TOKEN=your-secret-token

# Rate Limit (æ¯åˆ†é˜æœ€å¤šè«‹æ±‚æ¬¡æ•¸ï¼Œé è¨­: 60)
# RATE_LIMIT=60

# Request Body å¤§å°é™åˆ¶ (é è¨­: 1mb)
# BODY_LIMIT=1mb

# IP ç™½åå–® (é€—è™Ÿåˆ†éš”ï¼Œç•™ç©ºå…è¨±æ‰€æœ‰ï¼Œ* ä»£è¡¨ä»»æ„)
# ALLOWED_IPS=127.0.0.1,::1

# è­¦å ±éŸ³æ•ˆè¨­å®š (åƒ… macOS æœ‰æ•ˆ)
# é è¨­: Glass
ALERT_SOUND=Glass

# éŸ³é‡è¨­å®š
# ç¯„åœ: 0.0 ~ 1.0 (æ­£å¸¸éŸ³é‡), >1.0 (æ”¾å¤§)
# é è¨­: 0.5
ALERT_VOLUME=0.5
```

### ğŸ” API Token é©—è­‰

è‹¥è¨­å®šäº† `API_TOKEN`ï¼Œè«‹æ±‚ `/test` ç«¯é»æ™‚é ˆåœ¨ Header åŠ å…¥ Tokenï¼š

```bash
curl -X POST http://localhost:9999/test \
  -H "X-API-TOKEN: your-secret-token" \
  -d '{}'
```

æœªæä¾›æ­£ç¢º Token æ™‚æœƒæ”¶åˆ° `401 Unauthorized`ã€‚

### ğŸµ å¯ç”¨éŸ³æ•ˆåˆ—è¡¨ (macOS)

æ‚¨å¯ä»¥å°‡ `ALERT_SOUND` è¨­å®šç‚ºä»¥ä¸‹ä»»ä¸€å€¼ï¼š

- `Glass` (é è¨­ï¼Œæ¸…è„†ç»ç’ƒè²)
- `Bottle` (é¡ä¼¼å¹ç“¶å£çš„è²éŸ³)
- `Funk` (çŸ­ä¿ƒçš„ Funk éŸ³æ•ˆ)
- `Hero` (éŸ¿äº®çš„è™Ÿè§’è²)
- `Morse` (æ‘©æ–¯å¯†ç¢¼è²)
- `Ping` (é‡‘å±¬è²)
- `Pop` (æ°£æ³¡è²)
- `Purr` (å‘¼åš•è²)
- `Sosumi` (Sosumi éŸ³æ•ˆ)
- `Submarine` (æ½›æ°´è‰‡è²ç´)
- `Tink` (æ¸…è„†å®è²)

> âš ï¸ **æ³¨æ„**ï¼šä¿®æ”¹ `.env` æª”æ¡ˆå¾Œï¼Œå¿…é ˆ**é‡æ–°å•Ÿå‹•ä¼ºæœå™¨** (æˆ–é‡æ–°é–‹å§‹é™¤éŒ¯) æ‰æœƒç”Ÿæ•ˆã€‚

## ğŸ“¡ API ç«¯é»

| ç«¯é»      | æ–¹æ³• | èªªæ˜                     |
| --------- | ---- | ------------------------ |
| `/health` | GET  | æœå‹™å¥åº·æª¢æŸ¥             |
| `/stats`  | GET  | è«‹æ±‚çµ±è¨ˆè³‡è¨Š             |
| `/test`   | POST | Grafana Webhook æ¥æ”¶ç«¯é» |

### /test è«‹æ±‚ç¯„ä¾‹

```bash
curl -X POST http://localhost:9999/test \
  -H "Content-Type: application/json" \
  -H "X-API-TOKEN: your-secret-token" \
  -d '{
    "status": "firing",
    "alerts": [
      {
        "title": "High CPU Usage",
        "state": "firing"
      }
    ]
  }'
```

## âš™ï¸ Grafana è¨­å®šç¯„ä¾‹

åœ¨ Grafana çš„ **Contact Points** è¨­å®šä¸­ï¼š

1. **Integration**: é¸æ“‡ `Webhook`
2. **URL**: è¼¸å…¥æœ¬æ©Ÿä¼ºæœå™¨ä½å€
   - è‹¥ Grafana é‹è¡Œæ–¼ Docker ä¸­ï¼Œè«‹ä½¿ç”¨ï¼š`http://host.docker.internal:9999/test`
   - è‹¥ç›´æ¥é‹è¡Œï¼Œè«‹ä½¿ç”¨ï¼š`http://localhost:9999/test`
3. **HTTP Method**: POST
4. é»æ“Š **Test** æŒ‰éˆ•ç™¼é€æ¸¬è©¦é€šçŸ¥ï¼Œä½ æ‡‰è©²æœƒåœ¨çµ‚ç«¯æ©Ÿçœ‹åˆ°å½©è‰²çš„ Payload è¼¸å‡ºã€‚

## ğŸ§ª æ¸¬è©¦

```bash
# åŸ·è¡Œå–®å…ƒæ¸¬è©¦
npm test
```
